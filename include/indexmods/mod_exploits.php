<?php

####################################
# SURFids 3.00                     #
# Changeset 002                    #
# 19-08-2008                       #
# Jan van Lith & Kees Trippelvitz  #
####################################

#############################################
# Changelog:
# 002 Fixed organisation bug
# 001 Initial release
#############################################

$tsquery = "timestamp >= $from AND timestamp <= $to";

### Making sure the correct organisation is set.
if ($q_org != 0) {
  add_to_sql("sensors", "table");
  add_to_sql("sensors.organisation = $q_org", "where");
  add_to_sql("attacks.sensorid = sensors.id", "where");
}

### Checking for period.
add_to_sql("attacks", "table");
add_to_sql("attacks.id = details.attackid", "where");
add_to_sql("attacks.timestamp >= $from", "where");
add_to_sql("attacks.timestamp <= $to", "where");

echo "<div class='block'>\n";
  echo "<div class='dataBlock'>\n";
    echo "<div class='blockHeader'>" .$l['g_exploits']. "</div>\n";
    echo "<div class='blockContent'>\n";
      if ($err != 1) {
        ######### Table for Malicious attacks (SEV: 1) #############
        add_to_sql("attacks.id = details.attackid", "where");
        add_to_sql("attacks.severity = 1", "where");
        add_to_sql("details.type = 1", "where");
        add_to_sql("details.text = stats_dialogue.name", "where");
        if ($q_org != 0) {
          add_to_sql(gen_org_sql(), "where");
          add_to_sql("sensors", "table");
          add_to_sql("attacks.sensorid = sensors.id", "where");
        }
        add_to_sql("stats_dialogue", "table");
        add_to_sql("details", "table");
        add_to_sql("attacks", "table");
        add_to_sql("COUNT(DISTINCT details.attackid) as total", "select");
        add_to_sql("details.text", "select");
        add_to_sql("stats_dialogue.id", "select");
        add_to_sql("stats_dialogue.id", "group");
        add_to_sql("details.text", "group");
        add_to_sql("total", "order");

        # IP Exclusion stuff
        add_to_sql("NOT attacks.source IN (SELECT exclusion FROM org_excl WHERE orgid = $q_org)", "where");

        prepare_sql();

        ### Admin check.
        $sql_count = "SELECT $sql_select ";
        $sql_count .= "FROM $sql_from ";
        $sql_count .= " $sql_where ";
        if ($sql_group) {
          $sql_count .= " GROUP BY $sql_group ";
        }
        if ($sql_order) {
          $sql_count .= " ORDER BY $sql_order DESC ";
        }
        $debuginfo[] = "$sql_count";
        $result_count = pg_query($pgconn, $sql_count);
        $numrows_count = pg_num_rows($result_count);

        if ($numrows_count > 0) {
          echo "<table class='datatable'>\n";
            echo "<tr>\n";
              echo "<th width='80%'>" .$l['g_mal']. "</th>\n";
              echo "<th width='20%'>" .$l['g_stats']. "</th>\n";
            echo "</tr>\n";

            $total = 0;
            while ($row = pg_fetch_assoc($result_count)) {
              $id = $row['id'];
              $dia = $row['text'];
              $count = $row['total'];
              $total = $total + $count;
              $attack = $v_attacks_ar[$dia]["Attack"];
              $attack_url = $v_attacks_ar[$dia]["URL"];
              echo "<tr>\n";
                if ($attack_url != "") {
                  echo "<td><a href='$attack_url' target='new'>$attack</a></td>\n";
                } else { 
                  echo "<td>$attack</td>\n";
                }
                echo "<td>" .downlink("logsearch.php?int_sev=1&int_sevtype=0&int_attack=$id", nf($count)). "</td>\n";
              echo "</tr>\n";
            }
            echo "<tr class='bottom'>\n";
              echo "<td>" . $l['g_total']. "</td>\n";
              echo "<td>" .downlink("logsearch.php?int_sev=1&int_sevtype=0", nf($total)). "</td>\n";
            echo "</tr>\n";
          echo "</table>\n";
        } else {
          echo "<font class='warning'>" .$l['g_nofound']. "</font>\n";
        }
      }
    echo "</div>\n"; #</blockContent>
    echo "<div class='blockFooter'></div>\n";
  echo "</div>\n"; #</dataBlock>
echo "</div>\n"; #</block>
reset_sql();
?>
