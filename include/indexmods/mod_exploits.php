<?php

####################################
# SURFids 3.00                     #
# Changeset 004                    #
# 22-10-2009                       #
# Jan van Lith & Kees Trippelvitz  #
####################################

#############################################
# Changelog:
# 004 Fixed dependacy on v_attacks_ar
# 003 Fixed handling of Amun exploits
# 002 Fixed organisation bug
# 001 Initial release
#############################################

$tsquery = "timestamp >= $from AND timestamp <= $to";

### Making sure the correct organisation is set.
if ($q_org != 0) {
  add_to_sql("sensors", "table");
  add_to_sql("sensors.organisation = $q_org", "where");
  add_to_sql("attacks.sensorid = sensors.id", "where");
}

### Checking for period.
add_to_sql("attacks", "table");
add_to_sql("attacks.id = details.attackid", "where");
add_to_sql("attacks.timestamp >= $from", "where");
add_to_sql("attacks.timestamp <= $to", "where");

echo "<div class='block'>\n";
  echo "<div class='dataBlock'>\n";
    echo "<div class='blockHeader'>" .$l['g_exploits']. "</div>\n";
    echo "<div class='blockContent'>\n";
      if ($err != 1) {
        ######### Table for Malicious attacks (SEV: 1) #############

		# SELECT
        add_to_sql("COUNT(DISTINCT details.attackid) as total", "select");
        add_to_sql("details.text", "select");
        add_to_sql("stats_dialogue.id", "select");

		# WHERE
        add_to_sql("attacks.id = details.attackid", "where");
        add_to_sql("attacks.severity = 1", "where");
        add_to_sql("details.type IN (1, 84)", "where");
        add_to_sql("details.text = stats_dialogue.name", "where");
        if ($q_org != 0) {
          add_to_sql(gen_org_sql(), "where");
          add_to_sql("sensors", "table");
          add_to_sql("attacks.sensorid = sensors.id", "where");
        }

		# FROM
        add_to_sql("stats_dialogue", "table");
        add_to_sql("details", "table");
        add_to_sql("attacks", "table");

		# GROUP BY
        add_to_sql("stats_dialogue.id", "group");
        add_to_sql("details.text", "group");
        add_to_sql("total", "order");

        # IP Exclusion stuff
        add_to_sql("NOT attacks.source IN (SELECT exclusion FROM org_excl WHERE orgid = $q_org)", "where");

        prepare_sql();

        ### Admin check.
        $sql_count = "SELECT $sql_select ";
        $sql_count .= "FROM $sql_from ";
        $sql_count .= " $sql_where ";
        if ($sql_group) {
          $sql_count .= " GROUP BY $sql_group ";
        }
        if ($sql_order) {
          $sql_count .= " ORDER BY $sql_order DESC ";
        }
        $debuginfo[] = "$sql_count";
        $result_count = pg_query($pgconn, $sql_count);
        $numrows_count = pg_num_rows($result_count);

        if ($numrows_count > 0) {
          echo "<table class='datatable'>\n";
            echo "<tr>\n";
              echo "<th width='80%'>" .$l['g_mal']. "</th>\n";
              echo "<th width='20%'>" .$l['g_stats']. "</th>\n";
            echo "</tr>\n";

            $total = 0;
            while ($row = pg_fetch_assoc($result_count)) {
              $id = $row['id'];
              $dia = $row['text'];
              $count = $row['total'];
              $sevtype = $row['atype'];
              $total = $total + $count;
              if (strpos($dia, "Vulnerability") == False) {
                # Handling Nepenthes detail records
                $attack = str_replace("Dialogue", "", $dia);
              } else {
                # Handling Amun detail records
                $dia = str_replace("Vulnerability", "", $dia);
                $attack = trim($dia);
              }
              echo "<tr>\n";
                echo "<td>$attack</td>\n";
                echo "<td>" .downlink("logsearch.php?int_sev=1&int_sevtype=$sevtype&int_attack=$id", nf($count)). "</td>\n";
              echo "</tr>\n";
            }
            echo "<tr class='bottom'>\n";
              echo "<td>" . $l['g_total']. "</td>\n";
              echo "<td>" .downlink("logsearch.php?int_allexploits=1&int_sev=1", nf($total)). "</td>\n";
            echo "</tr>\n";
          echo "</table>\n";
        } else {
          echo "<font class='warning'>" .$l['g_nofound']. "</font>\n";
        }
      }
    echo "</div>\n"; #</blockContent>
    echo "<div class='blockFooter'></div>\n";
  echo "</div>\n"; #</dataBlock>
echo "</div>\n"; #</block>
reset_sql();
?>
