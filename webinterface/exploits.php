<?php $tab="3.2"; $pagetitle="Exploits"; include("menu.php"); contentHeader(); ?>
<?php

####################################
# SURFnet IDS                      #
# Version 2.00.01                  #
# 10-09-2007                       #
# Jan van Lith & Kees Trippelvitz  #
####################################
# Contributors:                    #
# Peter Arts                       #
####################################

#############################################
# Changelog:
# 2.00.01 Fixed binname in url to logsearch (renamed file)
# 1.04.09 Added IP exclusion stuff
# 1.04.08 Fixed missing link between sensors and attacks table
# 1.04.07 Fixed sql bug
# 1.04.06 add_to_sql()
# 1.04.05 Replaced $where[] with add_where()
# 1.04.04 Changed some sql stuff
# 1.04.03 Changed data input handling
# 1.04.02 Added extra check on severity in sql query when sev = 1
# 1.04.01 Rereleased as 1.04.01
# 1.03.03 Fixed a bug with 0 BD and AVG scans
# 1.03.02 Fixed an organisation bug when selecting ALL orgs and ALL logs
# 1.03.01 Released as part of the 1.03 package
# 1.02.13 Added intval() to session variables
# 1.02.12 Fixed typo in intval() function
# 1.02.11 Added some more input checks and removed includes
# 1.02.10 Fixed some organisation bugs
# 1.02.09 Minor bugfixes and code cleaning
# 1.02.08 Enhanced debugging
# 1.02.07 Added debug option
# 1.02.06 Fixed an organisation bug for normal users
# 1.02.05 Fixed some organisation bugs
# 1.02.04 Added number formatting
#############################################

### Making sure the correct organisation is set.
if ($q_org != 0) {
  add_to_sql("sensors", "table");
  add_to_sql("sensors.organisation = $q_org", "where");
  add_to_sql("attacks.sensorid = sensors.id", "where");
}

### Checking for period.
add_to_sql("attacks", "table");
add_to_sql("attacks.id = details.attackid", "where");
add_to_sql("attacks.timestamp >= $from", "where");
add_to_sql("attacks.timestamp <= $to", "where");

echo "<div class='left'>\n";
  echo "<div class='block'>\n";
    echo "<div class='dataBlock'>\n";
      echo "<div class='blockHeader'>Exploits</div>\n";
      echo "<div class='blockContent'>\n";
        if ($err != 1) {
          ######### Table for Malicious attacks (SEV: 1) #############
          add_to_sql("attacks.id = details.attackid", "where");
          add_to_sql("attacks.severity = 1", "where");
          add_to_sql("details.type = 1", "where");
          add_to_sql("details.text = stats_dialogue.name", "where");
          if ($q_org != 0) {
            add_to_sql(gen_org_sql(), "where");
            add_to_sql("sensors", "table");
            add_to_sql("attacks.sensorid = sensors.id", "where");
          }
          add_to_sql("stats_dialogue", "table");
          add_to_sql("details", "table");
          add_to_sql("attacks", "table");
          add_to_sql("COUNT(DISTINCT details.attackid) as total", "select");
          add_to_sql("details.text", "select");
          add_to_sql("stats_dialogue.id", "select");
          add_to_sql("details.text", "group");
          add_to_sql("stats_dialogue.id", "group");
          add_to_sql("total", "order");

          # IP Exclusion stuff
          add_to_sql("NOT attacks.source IN (SELECT exclusion FROM org_excl WHERE orgid = $s_org)", "where");

          prepare_sql();

          ### Admin check.
          $sql_count = "SELECT $sql_select ";
          $sql_count .= "FROM $sql_from ";
          $sql_count .= " $sql_where ";
          if ($sql_group) {
            $sql_count .= " GROUP BY $sql_group ";
          }
          if ($sql_order) {
            $sql_count .= " ORDER BY $sql_order DESC ";
          }
          $debuginfo[] = "$sql_count";
          $result_count = pg_query($pgconn, $sql_count);
          $numrows_count = pg_num_rows($result_count);

          if ($numrows_count > 0) {
            echo "<table class='datatable'>\n";
              echo "<tr>\n";
                echo "<th width='80%'>Malicious attacks</th>\n";
                echo "<th width='20%'>Statistics</th>\n";
              echo "</tr>\n";

              $total = 0;
              while ($row = pg_fetch_assoc($result_count)) {
                $id = $row['id'];
                $dia = $row['text'];
                $count = $row['total'];
                $total = $total + $count;
                $attack = $v_attacks_ar[$dia]["Attack"];
                $attack_url = $v_attacks_ar[$dia]["URL"];
                echo "<tr>\n";
                  if ($attack_url != "") {
                    echo "<td><a href='$attack_url' target='new'>$attack</a></td>\n";
                  } else { 
                    echo "<td>$attack</td>\n";
                  }
                  echo "<td>" .downlink("logsearch.php?int_sev=1&int_sevtype=0&int_attack=$id", nf($count)). "</td>\n";
                echo "</tr>\n";
              }
              echo "<tr class='bottom'>\n";
                echo "<td>Total</td>\n";
                echo "<td>" .downlink("logsearch.php?int_sev=1&int_sevtype=0", nf($total)). "</td>\n";
              echo "</tr>\n";
            echo "</table>\n";
          } else {
            echo "<font class='warning'>No records found!</font>\n";
          }
        }
      echo "</div>\n"; #</blockContent>
      echo "<div class='blockFooter'></div>\n";
    echo "</div>\n"; #</dataBlock>
  echo "</div>\n"; #</block>
echo "</div>\n"; #</left>

# Debug info
debug_sql();
pg_close($pgconn);
?>
<?php footer(); ?>
